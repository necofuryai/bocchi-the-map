---
name: Milestone Recorder

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  record-milestone:
    name: Record Implementation Milestone
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Analyze changes for milestone recording
        id: analyze
        run: |
          set -e
          
          echo "üîç Analyzing changes for milestone significance..."
          
          # Get commit range for analysis
          if [ "${{ github.event_name }}" == "push" ]; then
            COMMIT_RANGE="${{ github.event.before }}..${{ github.event.after }}"
          else
            # For merged PRs
            COMMIT_RANGE="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          fi
          
          # Analyze commits
          COMMITS=$(git log --oneline "$COMMIT_RANGE" 2>/dev/null || echo "")
          
          # Check for significant changes
          MILESTONE_WORTHY=false
          MILESTONE_TYPE=""
          MILESTONE_DESCRIPTION=""
          
          # Feature additions
          if echo "$COMMITS" | grep -E "^[a-f0-9]+ feat:" > /dev/null; then
            MILESTONE_WORTHY=true
            MILESTONE_TYPE="feature"
            FEATURES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ feat:" | sed 's/^[a-f0-9]* feat: /‚Ä¢ /')
            MILESTONE_DESCRIPTION="New Features:\n$FEATURES"
          fi
          
          # Major fixes
          if echo "$COMMITS" | grep -E "^[a-f0-9]+ fix:" | wc -l | grep -E "^[3-9]|[1-9][0-9]" > /dev/null; then
            MILESTONE_WORTHY=true
            if [ -n "$MILESTONE_TYPE" ]; then
              MILESTONE_TYPE="mixed"
            else
              MILESTONE_TYPE="fixes"
            fi
            FIXES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ fix:" | head -5 | sed 's/^[a-f0-9]* fix: /‚Ä¢ /')
            if [ -n "$MILESTONE_DESCRIPTION" ]; then
              MILESTONE_DESCRIPTION="$MILESTONE_DESCRIPTION\n\nMajor Fixes:\n$FIXES"
            else
              MILESTONE_DESCRIPTION="Major Fixes:\n$FIXES"
            fi
          fi
          
          # Infrastructure improvements
          if echo "$COMMITS" | grep -E "^[a-f0-9]+ (ci|build|improve):" > /dev/null; then
            INFRA_CHANGES=$(echo "$COMMITS" | grep -E "^[a-f0-9]+ (ci|build|improve):" | head -3 | sed 's/^[a-f0-9]* [^:]*: /‚Ä¢ /')
            if [ -n "$MILESTONE_DESCRIPTION" ]; then
              MILESTONE_DESCRIPTION="$MILESTONE_DESCRIPTION\n\nInfrastructure Improvements:\n$INFRA_CHANGES"
            elif [ $(echo "$INFRA_CHANGES" | wc -l) -ge 2 ]; then
              MILESTONE_WORTHY=true
              MILESTONE_TYPE="infrastructure"
              MILESTONE_DESCRIPTION="Infrastructure Improvements:\n$INFRA_CHANGES"
            fi
          fi
          
          # Get current date
          CURRENT_DATE=$(date '+%YÂπ¥%mÊúà%dÊó•')
          
          echo "milestone_worthy=$MILESTONE_WORTHY" >> $GITHUB_OUTPUT
          echo "milestone_type=$MILESTONE_TYPE" >> $GITHUB_OUTPUT
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "milestone_description<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MILESTONE_DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update implementation log
        if: steps.analyze.outputs.milestone_worthy == 'true'
        run: |
          set -e
          
          MILESTONE_TYPE="${{ steps.analyze.outputs.milestone_type }}"
          CURRENT_DATE="${{ steps.analyze.outputs.current_date }}"
          DESCRIPTION="${{ steps.analyze.outputs.milestone_description }}"
          
          # Create milestone entry
          case "$MILESTONE_TYPE" in
            "feature")
              EMOJI="‚ú®"
              TITLE="Êñ∞Ê©üËÉΩÂÆüË£Ö"
              ;;
            "fixes") 
              EMOJI="üîß"
              TITLE="ÈáçË¶Å„Å™‰øÆÊ≠£„ÉªÊîπÂñÑ"
              ;;
            "infrastructure")
              EMOJI="üöÄ"
              TITLE="„Ç§„É≥„Éï„É©„ÉªCI/CDÊîπÂñÑ"
              ;;
            "mixed")
              EMOJI="üìà"
              TITLE="Ê©üËÉΩËøΩÂä†„Éª‰øÆÊ≠£„ÉªÊîπÂñÑ"
              ;;
            *)
              EMOJI="üìù"
              TITLE="ÂÆüË£ÖÊõ¥Êñ∞"
              ;;
          esac
          
          # Prepare milestone entry
          MILESTONE_ENTRY="## $EMOJI $CURRENT_DATE - $TITLE

### ÂÆüË£ÖÂÜÖÂÆπ
$DESCRIPTION

### „É™„Éù„Ç∏„Éà„É™ÊÉÖÂ†±
- **„Éñ„É©„É≥„ÉÅ**: ${{ github.ref_name }}
- **„Ç≥„Éü„ÉÉ„Éà**: ${{ github.sha }}
- **ÂÆüË£ÖËÄÖ**: Automated milestone recording

---

"
          
          # Insert milestone at the beginning of the milestones section
          if [ -f "docs/IMPLEMENTATION_LOG.md" ]; then
            # Create temporary file with new milestone
            echo "$MILESTONE_ENTRY" > temp_milestone.md
            
            # Find insertion point (after the current status section)
            if grep -n "## üìÖ ‰∏ªË¶ÅÂÆüË£Ö„Éû„Ç§„É´„Çπ„Éà„Éº„É≥" docs/IMPLEMENTATION_LOG.md > /dev/null; then
              # Insert after the milestone header
              LINE_NUM=$(grep -n "## üìÖ ‰∏ªË¶ÅÂÆüË£Ö„Éû„Ç§„É´„Çπ„Éà„Éº„É≥" docs/IMPLEMENTATION_LOG.md | cut -d: -f1)
              head -n $LINE_NUM docs/IMPLEMENTATION_LOG.md > temp_log.md
              echo "" >> temp_log.md
              cat temp_milestone.md >> temp_log.md
              tail -n +$((LINE_NUM + 1)) docs/IMPLEMENTATION_LOG.md >> temp_log.md
              mv temp_log.md docs/IMPLEMENTATION_LOG.md
            else
              # If no milestones section, append to end
              echo "" >> docs/IMPLEMENTATION_LOG.md
              echo "## üìÖ ‰∏ªË¶ÅÂÆüË£Ö„Éû„Ç§„É´„Çπ„Éà„Éº„É≥" >> docs/IMPLEMENTATION_LOG.md
              echo "" >> docs/IMPLEMENTATION_LOG.md
              cat temp_milestone.md >> docs/IMPLEMENTATION_LOG.md
            fi
            
            rm temp_milestone.md
            
            echo "‚úÖ Milestone recorded in docs/IMPLEMENTATION_LOG.md"
          else
            echo "‚ö†Ô∏è docs/IMPLEMENTATION_LOG.md not found, skipping milestone recording"
          fi

      - name: Commit milestone update
        if: steps.analyze.outputs.milestone_worthy == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet docs/IMPLEMENTATION_LOG.md; then
            echo "No changes to commit"
          else
            git add docs/IMPLEMENTATION_LOG.md
            git commit -m "docs: record milestone for ${{ steps.analyze.outputs.milestone_type }} updates

ü§ñ Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
            
            # Push the changes
            git push origin ${{ github.ref_name }}
            
            echo "‚úÖ Milestone committed and pushed"
          fi

      - name: Create summary comment
        if: steps.analyze.outputs.milestone_worthy == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const milestoneType = '${{ steps.analyze.outputs.milestone_type }}';
            const currentDate = '${{ steps.analyze.outputs.current_date }}';
            
            const comment = `## üéâ Milestone Recorded!

‚úÖ **Significant changes detected** - A milestone has been automatically recorded in \`docs/IMPLEMENTATION_LOG.md\`

**Milestone Type:** ${milestoneType}  
**Date:** ${currentDate}

This helps maintain our implementation history and project documentation integrity.

ü§ñ *Automated milestone recording by GitHub Actions*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });