---
name: E2E Test Progress Tracker

on:
  workflow_run:
    workflows: ["E2E Tests", "Playwright Tests"]
    types: [completed]
  schedule:
    # Run weekly to track progress trends
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update progress tracking'
        required: false
        default: 'false'

jobs:
  track-e2e-progress:
    name: Track E2E Test Progress
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'

      - name: Install dependencies
        working-directory: web
        run: npm ci

      - name: Run E2E tests and capture results
        working-directory: web
        continue-on-error: true
        run: |
          # Install Playwright browsers
          npx playwright install --with-deps

          # Run E2E tests with JSON reporter and capture exit code
          EXIT_CODE=0
          npx playwright test --reporter=json > \
            ../e2e-results.json || EXIT_CODE=$?
          echo "JSON_TEST_EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV

          # Also generate HTML report for artifacts and capture exit code
          HTML_EXIT_CODE=0
          npx playwright test --reporter=html || HTML_EXIT_CODE=$?
          echo "HTML_TEST_EXIT_CODE=$HTML_EXIT_CODE" >> $GITHUB_ENV

          # Log exit codes for debugging
          echo "E2E Test Exit Codes:"
          echo "  JSON reporter exit code: $EXIT_CODE"
          echo "  HTML reporter exit code: $HTML_EXIT_CODE"

          if [ $EXIT_CODE -ne 0 ] || [ $HTML_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ E2E tests failed with non-zero exit codes"
          else
            echo "âœ… E2E tests completed successfully"
          fi

      - name: Analyze E2E test results
        id: analyze
        run: |
          set -e

          if [ ! -f "e2e-results.json" ]; then
            echo "No E2E results found, creating placeholder"
            echo '{"stats":{"expected":0,"passed":0,"failed":0,' \
              '"flaky":0,"skipped":0}}' > e2e-results.json
          fi

          # Parse test results using external script
          eval $(node scripts/parse-e2e-results.js e2e-results.json)

          # Get current date
          CURRENT_DATE=$(date '+%Y-%m-%d')
          CURRENT_DATETIME=$(date '+%Y-%m-%d %H:%M:%S UTC')

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "current_datetime=$CURRENT_DATETIME" >> $GITHUB_OUTPUT

          echo "ðŸ“Š E2E Test Results:"
          echo "   Total: $TOTAL_TESTS"
          echo "   Passed: $PASSED_TESTS"
          echo "   Failed: $FAILED_TESTS"
          echo "   Success Rate: $SUCCESS_RATE%"

      - name: Check for significant progress
        id: progress-check
        run: |
          SUCCESS_RATE=${{ steps.analyze.outputs.success_rate }}

          # Define milestones
          MILESTONE_ACHIEVED=false
          MILESTONE_TYPE=""

          if (( SUCCESS_RATE == 100 )); then
            MILESTONE_ACHIEVED=true
            MILESTONE_TYPE="completion"
            echo "ðŸŽ‰ 100% E2E test success achieved!"
          elif (( SUCCESS_RATE >= 95 )); then
            MILESTONE_ACHIEVED=true
            MILESTONE_TYPE="near_completion"
            echo "ðŸŒŸ 95%+ E2E test success achieved!"
          elif (( SUCCESS_RATE >= 90 )); then
            MILESTONE_ACHIEVED=true
            MILESTONE_TYPE="excellent"
            echo "âœ¨ 90%+ E2E test success achieved!"
          fi

          echo "milestone_achieved=$MILESTONE_ACHIEVED" >> $GITHUB_OUTPUT
          echo "milestone_type=$MILESTONE_TYPE" >> $GITHUB_OUTPUT

      - name: Update progress tracking file
        run: |
          set -e

          CURRENT_DATE="${{ steps.analyze.outputs.current_date }}"
          CURRENT_DATETIME="${{ steps.analyze.outputs.current_datetime }}"
          TOTAL_TESTS=${{ steps.analyze.outputs.total_tests }}
          PASSED_TESTS=${{ steps.analyze.outputs.passed_tests }}
          FAILED_TESTS=${{ steps.analyze.outputs.failed_tests }}
          SUCCESS_RATE=${{ steps.analyze.outputs.success_rate }}

          # Create or update progress tracking file
          PROGRESS_FILE="docs/e2e-test-progress.md"

          if [ ! -f "$PROGRESS_FILE" ]; then
            {
              echo "# E2E Test Progress Tracking"
              echo ""
              echo "This file tracks the progress of End-to-End " \
                "(E2E) test implementation and success rates."
              echo ""
              echo "## Current Status"
              echo ""
              echo "**Target:** 100% E2E test success rate"
              echo "**Current Progress:** " \
                "Automatically updated by GitHub Actions"
              echo ""
              echo "## Progress History"
              echo ""
              echo "| Date | Total Tests | Passed | Failed | " \
                "Success Rate | Notes |"
              echo "|------|-------------|--------|--------|" \
                "--------------|-------|"
            } > "$PROGRESS_FILE"
          fi

          # Add current progress entry
          echo "| $CURRENT_DATE | $TOTAL_TESTS | $PASSED_TESTS | " \
            "$FAILED_TESTS | $SUCCESS_RATE% | Automated tracking |" >> \
            "$PROGRESS_FILE"

          echo "âœ… Updated progress tracking in $PROGRESS_FILE"

      - name: Record milestone if achieved
        if: steps.progress-check.outputs.milestone_achieved == 'true'
        run: |
          set -e

          MILESTONE_TYPE="${{ steps.progress-check.outputs.milestone_type }}"
          SUCCESS_RATE=${{ steps.analyze.outputs.success_rate }}
          CURRENT_DATE="${{ steps.analyze.outputs.current_date }}"
          TOTAL_TESTS=${{ steps.analyze.outputs.total_tests }}
          PASSED_TESTS=${{ steps.analyze.outputs.passed_tests }}

          case "$MILESTONE_TYPE" in
            "completion")
              EMOJI="ðŸŽ‰"
              TITLE="E2Eãƒ†ã‚¹ãƒˆ100%é”æˆ"
              DESCRIPTION="### ðŸŽ¯ å®Œå…¨ãªæˆåŠŸé”æˆ!" \
                $'\n\n' \
                "ã™ã¹ã¦ã®E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã€" \
                "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å“è³ªãŒæœ€é«˜æ°´æº–ã«é”ã—ã¾ã—ãŸï¼" \
                $'\n\n' \
                "**é”æˆæŒ‡æ¨™:**" \
                $'\n' \
                "- âœ… ç·ãƒ†ã‚¹ãƒˆæ•°: $TOTAL_TESTS" \
                $'\n' \
                "- âœ… æˆåŠŸãƒ†ã‚¹ãƒˆ: $PASSED_TESTS" \
                $'\n' \
                "- âœ… å¤±æ•—ãƒ†ã‚¹ãƒˆ: 0" \
                $'\n' \
                "- ðŸŽ¯ **æˆåŠŸçŽ‡: 100%**" \
                $'\n\n' \
                "**æŠ€è¡“çš„æˆæžœ:**" \
                $'\n' \
                "- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å“è³ªã®å®Œå…¨ä¿è¨¼" \
                $'\n' \
                "- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨ãªå‹•ä½œç¢ºèª" \
                $'\n' \
                "- ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†çŠ¶æ…‹ã®ç¢ºç«‹"
              ;;
            "near_completion")
              EMOJI="ðŸŒŸ"
              TITLE="E2Eãƒ†ã‚¹ãƒˆ95%ä»¥ä¸Šé”æˆ"
              DESCRIPTION="### ðŸŒŸ å„ªç§€ãªå“è³ªãƒ¬ãƒ™ãƒ«é”æˆ!" \
                $'\n\n' \
                "**é”æˆæŒ‡æ¨™:**" \
                $'\n' \
                "- âœ… ç·ãƒ†ã‚¹ãƒˆæ•°: $TOTAL_TESTS" \
                $'\n' \
                "- âœ… æˆåŠŸãƒ†ã‚¹ãƒˆ: $PASSED_TESTS" \
                $'\n' \
                "- âš ï¸ æ®‹ã‚Šä¿®æ­£: $((TOTAL_TESTS - PASSED_TESTS))" \
                $'\n' \
                "- ðŸŽ¯ **æˆåŠŸçŽ‡: $SUCCESS_RATE%**" \
                $'\n\n' \
                "**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**" \
                $'\n' \
                "- æ®‹ã‚Šã®å°‘æ•°ãƒ†ã‚¹ãƒˆã®ä¿®æ­£å®Œäº†" \
                $'\n' \
                "- 100%é”æˆã¸ã®æœ€çµ‚æ®µéšŽ"
              ;;
            "excellent")
              EMOJI="âœ¨"
              TITLE="E2Eãƒ†ã‚¹ãƒˆ90%ä»¥ä¸Šé”æˆ"
              DESCRIPTION="### âœ¨ é«˜å“è³ªãƒ¬ãƒ™ãƒ«é”æˆ!" \
                $'\n\n' \
                "**é”æˆæŒ‡æ¨™:**" \
                $'\n' \
                "- âœ… ç·ãƒ†ã‚¹ãƒˆæ•°: $TOTAL_TESTS" \
                $'\n' \
                "- âœ… æˆåŠŸãƒ†ã‚¹ãƒˆ: $PASSED_TESTS" \
                $'\n' \
                "- ðŸ”§ ä¿®æ­£å¯¾è±¡: $((TOTAL_TESTS - PASSED_TESTS))" \
                $'\n' \
                "- ðŸŽ¯ **æˆåŠŸçŽ‡: $SUCCESS_RATE%**"
              ;;
          esac

          # Insert milestone into implementation log
          if [ -f "docs/IMPLEMENTATION_LOG.md" ]; then
            printf -v MILESTONE_ENTRY \
              "## %s %s - %s\n\n%s\n\n" \
              "### è‡ªå‹•è¨˜éŒ²æƒ…å ±\n- **æ¸¬å®šæ—¥æ™‚**: %s\n" \
              "- **æ¸¬å®šæ–¹æ³•**: GitHub Actionsè‡ªå‹•å®Ÿè¡Œ\n" \
              "- **Playwright Version**: Latest\n\n---\n\n" \
              "$EMOJI" "$CURRENT_DATE" "$TITLE" "$DESCRIPTION" \
              "${{ steps.analyze.outputs.current_datetime }}"

            # Insert milestone
            if grep -n "## ðŸ“… ä¸»è¦å®Ÿè£…ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³" \
              docs/IMPLEMENTATION_LOG.md > /dev/null; then
              LINE_NUM=$(grep -n "## ðŸ“… ä¸»è¦å®Ÿè£…ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³" \
                docs/IMPLEMENTATION_LOG.md | cut -d: -f1)
              head -n $LINE_NUM docs/IMPLEMENTATION_LOG.md > temp_log.md
              echo "" >> temp_log.md
              echo "$MILESTONE_ENTRY" >> temp_log.md
              tail -n +$((LINE_NUM + 1)) docs/IMPLEMENTATION_LOG.md >> \
                temp_log.md
              mv temp_log.md docs/IMPLEMENTATION_LOG.md
            else
              echo "" >> docs/IMPLEMENTATION_LOG.md
              echo "## ðŸ“… ä¸»è¦å®Ÿè£…ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³" >> docs/IMPLEMENTATION_LOG.md
              echo "" >> docs/IMPLEMENTATION_LOG.md
              echo "$MILESTONE_ENTRY" >> docs/IMPLEMENTATION_LOG.md
            fi

            echo "ðŸŽ‰ E2E milestone recorded!"
          fi

      - name: Commit progress updates
        run: |
          git config --local user.email \
            "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/e2e-test-progress.md

          if [ "${{ steps.progress-check.outputs.milestone_achieved }}" \
            == "true" ]; then
            git add docs/IMPLEMENTATION_LOG.md
            COMMIT_MSG="docs: record E2E test milestone - " \
              "${{ steps.analyze.outputs.success_rate }}% success rate"
          else
            COMMIT_MSG="docs: update E2E test progress tracking"
          fi

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            FULL_COMMIT_MSG="$COMMIT_MSG" \
              $'\n\n' \
              "ðŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
              $'\n\n' \
              "Co-Authored-By: Claude <noreply@anthropic.com>"
            git commit -m "$FULL_COMMIT_MSG"

            git push origin ${{ github.ref_name }}
            echo "âœ… Progress committed and pushed"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-progress-results
          path: |
            e2e-results.json
            web/playwright-report/
            docs/e2e-test-progress.md
          if-no-files-found: ignore
